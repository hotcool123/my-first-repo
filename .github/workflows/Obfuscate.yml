name: Build and Upload JS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-js:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Prepare workspace
        run: |
          mkdir -p $GITHUB_WORKSPACE/.github/workflows
          echo "OUTPUT_DIR=$GITHUB_WORKSPACE/.github/workflows" >> $GITHUB_ENV

      - name: Download origin.js
        run: |
          DEST="$OUTPUT_DIR/origin.js"
          RAW_MAIN="https://raw.githubusercontent.com/bia-pain-bache/BPB-Worker-Panel/main/build/unobfuscated-worker.js"
          echo "Trying to download $RAW_MAIN"
          if ! wget -q -O "$DEST" --tries=3 --timeout=30 "$RAW_MAIN"; then
            echo "// Placeholder origin.js" > "$DEST"
          fi

      - name: Obfuscate origin.js -> works.js
        run: |
          npm install -g javascript-obfuscator
          javascript-obfuscator "$OUTPUT_DIR/origin.js" \
            --output "$OUTPUT_DIR/works.js" \
            --compact true \
            --control-flow-flattening true

      - name: Upload JS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: origin-and-works
          path: |
            $OUTPUT_DIR/origin.js
            $OUTPUT_DIR/works.js
